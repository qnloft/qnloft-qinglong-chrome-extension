# PRD: Cookie选择性同步和删除功能

## 1. 简介/概述

本文档描述了为青龙Cookie同步Chrome插件新增的两个功能：Cookie选择性同步和Cookie删除功能。这些功能将增强用户对Cookie管理的控制能力，提供更灵活的同步选项和清理功能。

**解决的问题：**
1. 用户无法选择性地同步特定Cookie，只能同步所有Cookie
2. 用户无法清理不需要的Cookie，导致环境变量中积累无效数据

**主要目标：**
提供精确的Cookie管理控制，让用户能够选择性地同步需要的Cookie，并能够清理不需要的Cookie数据。

## 2. 目标

1. **精确控制：** 允许用户选择特定Cookie进行同步，而不是同步所有Cookie
2. **数据清理：** 提供删除Cookie的功能，保持环境变量数据的整洁
3. **用户友好：** 提供直观的界面和操作流程
4. **安全可靠：** 确保删除操作有适当的确认机制

## 3. 用户故事

**US-01: 作为用户**，我希望在查看Cookie时能够选择特定的Cookie进行同步，这样我可以只同步需要的Cookie而不影响其他Cookie。

**US-02: 作为用户**，我希望能够删除网站的所有Cookie，这样我可以清理不需要的Cookie数据。

**US-03: 作为用户**，我希望在删除Cookie时有确认提示，这样我可以避免误删重要数据。

**US-04: 作为用户**，我希望能够看到哪些Cookie被选中了，这样我可以确认同步的内容。

## 4. 功能需求

### 4.1 Cookie选择性同步功能

**FR-01:** 系统必须在"查看Cookie"模态框中为每个Cookie添加复选框，允许用户选择要同步的Cookie。

**FR-02:** 系统必须提供"全选"和"取消全选"功能，方便用户快速选择。

**FR-03:** 系统必须在Cookie列表底部显示选中Cookie的数量统计。

**FR-04:** 系统必须提供"同步选中Cookie"按钮，将选中的Cookie同步到该网站配置对应的青龙环境变量。

**FR-05:** 系统必须在同步前验证至少选择了一个Cookie。

**FR-06:** 系统必须在同步过程中显示进度提示。

**FR-07:** 系统必须在同步完成后显示成功提示和同步的Cookie数量。

**FR-08:** 系统必须在同步失败时显示详细错误信息。

**FR-09:** 系统必须保持原有的"关闭"按钮功能不变。

### 4.2 Cookie删除功能

**FR-10:** 系统必须在网站配置管理列表的每个网站卡片中添加"删除Cookie"按钮。

**FR-11:** 系统必须在点击"删除Cookie"按钮时显示确认对话框，包含：
- 网站名称
- 将要删除的Cookie数量
- 警告信息

**FR-12:** 系统必须提供"确认删除"和"取消"两个选项。

**FR-13:** 系统必须在确认删除后删除该网站的所有Cookie。

**FR-14:** 系统必须在删除过程中显示进度提示。

**FR-15:** 系统必须在删除完成后显示成功提示和删除的Cookie数量。

**FR-16:** 系统必须在删除失败时显示详细错误信息。

**FR-17:** 系统必须确保删除操作不会影响青龙面板中的环境变量。

## 5. 非目标（范围外）

**NG-01:** 本版本不支持删除特定Cookie（只能删除所有Cookie）。

**NG-02:** 本版本不支持批量删除多个网站的Cookie。

**NG-03:** 本版本不支持删除青龙面板中的环境变量。

**NG-04:** 本版本不支持Cookie的备份和恢复功能。

## 6. 设计考虑

### 6.1 Cookie选择性同步界面设计

**现有Cookie查看模态框增强：**

在现有的Cookie表格上方添加选择控制区域：
```
┌─────────────────────────────────────────┐
│ Cookie列表 - [网站名称]                  │
├─────────────────────────────────────────┤
│ ☑ 全选  ☐ 取消全选  已选择: 0 个Cookie  │
├─────────────────────────────────────────┤
│ [名称] [值] [域名] [路径] [过期时间] [状态] │
│ ☑ Cookie1  ••••••  .example.com ...     │
│ ☐ Cookie2  ••••••  .example.com ...     │
│ ☑ Cookie3  ••••••  .example.com ...     │
├─────────────────────────────────────────┤
│ [同步选中Cookie] [关闭]                  │
└─────────────────────────────────────────┘
```

**交互流程：**
1. 用户点击"查看Cookie"按钮
2. 系统显示Cookie列表，每个Cookie前有复选框
3. 用户可以选择特定Cookie或使用全选功能
4. 用户点击"同步选中Cookie"按钮
5. 系统验证选择并执行同步
6. 显示同步结果

### 6.2 Cookie删除功能界面设计

**网站配置卡片增强：**

在现有的网站卡片操作按钮区域添加删除Cookie按钮：
```
┌─────────────────────────────────────────┐
│ [网站名称]                              │
│ [检测Cookie] [查看Cookie] [打开网站]     │
│ [编辑] [删除] [删除Cookie] ← 新增按钮    │
└─────────────────────────────────────────┘
```

**确认对话框设计：**
```
┌─────────────────────────────────────────┐
│ ⚠️ 确认删除Cookie                        │
├─────────────────────────────────────────┤
│ 网站: 京东                               │
│ 将删除: 15 个Cookie                     │
│                                         │
│ 此操作将删除该网站的所有Cookie，         │
│ 但不会影响青龙面板中的环境变量。         │
│                                         │
│ [确认删除] [取消]                       │
└─────────────────────────────────────────┘
```

## 7. 技术考虑

### 7.1 Chrome APIs

- **chrome.cookies.getAll:** 获取网站的所有Cookie
- **chrome.cookies.remove:** 删除特定Cookie
- **chrome.cookies.removeAll:** 删除网站的所有Cookie

### 7.2 实现细节

**Cookie选择性同步：**
1. 修改现有的`showCookieModal`函数，添加复选框列
2. 添加选择状态管理（全选、部分选择、无选择）
3. 实现选中Cookie的收集和验证
4. 调用现有的同步API，但只传递选中的Cookie

**Cookie删除功能：**
1. 在网站配置卡片中添加"删除Cookie"按钮
2. 实现确认对话框组件
3. 使用`chrome.cookies.removeAll`删除所有Cookie
4. 添加错误处理和用户反馈

### 7.3 数据结构

**选中Cookie状态：**
```javascript
{
  selectedCookies: Set<string>, // 选中的Cookie名称集合
  totalCount: number,           // 总Cookie数量
  selectedCount: number         // 选中Cookie数量
}
```

**删除确认状态：**
```javascript
{
  siteId: string,              // 网站ID
  siteName: string,           // 网站名称
  cookieCount: number,        // Cookie数量
  isDeleting: boolean         // 是否正在删除
}
```

## 8. 成功指标

**SM-01:** 用户能够在30秒内完成Cookie的选择和同步操作。

**SM-02:** Cookie删除操作的成功率达到100%（排除权限问题）。

**SM-03:** 用户能够通过界面提示理解每个操作的影响范围。

**SM-04:** 确认对话框能够有效防止误删操作。

## 9. 开放问题

**OQ-01:** 删除Cookie后是否需要刷新Cookie状态显示？
- **建议：** 删除后自动刷新Cookie状态，显示"无Cookie"状态。

**OQ-02:** 选择性同步时如何处理Cookie格式？
- **建议：** 保持与现有同步逻辑一致，将选中的Cookie按原有格式组合。

**OQ-03:** 是否需要记录Cookie删除的历史？
- **建议：** 第一版本不记录删除历史，后续版本根据用户反馈考虑添加。

**OQ-04:** 删除Cookie按钮的样式如何设计？
- **建议：** 使用红色危险按钮样式，与"删除"按钮保持一致。

---

## 附录：现有代码分析

当前`options.js`中已实现的相关功能：
- ✅ `showCookieModal`函数 - 显示Cookie列表模态框
- ✅ Cookie表格渲染 - 包含名称、值、域名、路径、过期时间、状态
- ✅ Cookie值的显示/隐藏切换
- ✅ Cookie值的复制功能
- ✅ 网站配置卡片的操作按钮

需要修改的部分：
- 🔨 `showCookieModal`函数 - 添加复选框列和选择控制
- ➕ 添加Cookie选择状态管理
- ➕ 添加"同步选中Cookie"按钮和逻辑
- ➕ 在网站配置卡片中添加"删除Cookie"按钮
- ➕ 实现Cookie删除确认对话框
- ➕ 实现Cookie删除逻辑

图例：
- ✅ 已实现
- 🔨 需要修改/增强
- ➕ 需要新增
