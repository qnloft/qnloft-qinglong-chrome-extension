# PRD: Cookie同步到青龙面板的Chrome插件

## 1. 简介/概述

本文档描述了一个Chrome浏览器扩展插件，该插件能够自动获取用户指定网站的Cookie，并将这些Cookie同步到青龙面板（QingLong Panel）的环境变量中。

**解决的问题：**
用户在使用青龙面板进行自动化任务时，需要频繁手动更新Cookie信息。Cookie通常有过期时间，手动复制粘贴既繁琐又容易出错。本插件通过自动化这一流程，极大提升了用户体验和效率。

**主要目标：**
提供一个易用、可靠、安全的Chrome插件，自动化Cookie从浏览器到青龙面板的同步流程，并提供便捷的青龙面板环境变量管理功能。

## 2. 目标

1. **灵活性：** 支持用户自定义添加任意网站的Cookie获取配置
2. **自动化：** 提供多种自动同步方式，减少用户手动操作
3. **可靠性：** 提供完善的错误处理、通知和日志记录机制
4. **易用性：** 提供直观的用户界面和配置向导
5. **安全性：** 安全存储敏感配置信息，支持配置备份和恢复
6. **可维护性：** 提供批量管理功能和连接测试功能
7. **集成性：** 提供完整的青龙面板环境变量管理功能，无需频繁切换到青龙面板操作

## 3. 用户故事

**US-01: 作为用户**，我希望能够添加多个不同网站的Cookie同步配置，这样我可以管理多个平台的自动化任务。

**US-02: 作为用户**，我希望插件能够自动检测Cookie变化并同步，这样我不需要记住何时Cookie过期了。

**US-03: 作为用户**，我希望在配置青龙面板时能够测试连接是否成功，这样我可以立即发现配置错误。

**US-04: 作为新用户**，我希望有一个配置向导引导我完成初始设置，这样我可以快速上手使用插件。

**US-05: 作为用户**，我希望能够查看同步历史和日志，这样我可以了解插件的运行状态和排查问题。

**US-06: 作为用户**，我希望能够导出和导入配置，这样我可以在多个浏览器或重装后快速恢复设置。

**US-07: 作为用户**，我希望能够批量管理多个环境变量，这样我可以同时同步多个网站的Cookie到青龙面板。

**US-08: 作为用户**，我希望在同步失败时收到详细的错误信息，这样我可以快速定位和解决问题。

**US-09: 作为用户**，我希望能够在插件中直接查看和管理青龙面板的所有环境变量，这样我不需要频繁切换到青龙面板网页进行操作。

## 4. 功能需求

### 4.1 网站配置管理

**FR-01:** 系统必须允许用户添加新的网站配置，包括：
- 网站名称（用户自定义）
- 目标URL（用于获取Cookie）
- 对应的青龙环境变量名称
- 是否启用此配置

**FR-02:** 系统必须允许用户编辑已存在的网站配置。

**FR-03:** 系统必须允许用户删除网站配置。

**FR-04:** 系统必须显示所有已配置网站的列表，包括状态（启用/禁用）。

**FR-05:** 系统必须获取目标网站的所有Cookie（而非指定名称的Cookie）。

### 4.2 青龙面板配置

**FR-06:** 系统必须允许用户配置青龙面板连接信息：
- 青龙面板URL
- Client ID
- Client Secret

**FR-07:** 系统必须提供"测试连接"功能，验证青龙面板配置是否正确。

**FR-08:** 系统必须支持批量管理多个环境变量（对应多个网站配置）。

### 4.3 同步功能

**FR-09:** 系统必须支持手动触发Cookie同步，提供明显的同步按钮。

**FR-10:** 系统必须支持定时自动同步，允许用户设置同步间隔（最小1分钟）。

**FR-11:** 系统必须支持检测Cookie变化时自动同步（监听Cookie变更事件）。

**FR-12:** 系统必须允许用户为每个网站配置独立启用/禁用自动同步。

**FR-13:** 系统必须在同步前检查必要的配置是否完整（青龙面板配置、网站配置）。

**FR-14:** 系统必须在同步时更新青龙面板中对应的环境变量值。

**FR-15:** 系统必须在环境变量不存在时提示用户先在青龙面板中创建。

### 4.4 用户界面

**FR-16:** 系统必须提供Popup界面，显示：
- 当前同步状态
- 所有网站配置列表及其状态
- 手动同步按钮
- 进入设置页面的入口

**FR-17:** 系统必须提供Options配置页面，包含：
- 青龙面板配置区域
- 网站配置管理区域
- 环境变量管理区域
- 同步设置区域
- 安全设置区域

**FR-18:** 系统必须在首次安装时显示配置向导，引导用户完成：
- 步骤1: 配置青龙面板
- 步骤2: 添加第一个网站配置
- 步骤3: 完成并测试同步

**FR-19:** 系统必须实时显示Cookie状态（是否存在、最后更新时间）。

**FR-20:** 系统必须显示同步历史记录，包括：
- 同步时间
- 同步的网站
- 同步结果（成功/失败）
- 错误信息（如果失败）

### 4.5 通知和错误处理

**FR-21:** 系统必须通过扩展图标徽章显示状态：
- 绿色勾号：同步成功
- 红色感叹号：同步失败
- 无徽章：正常待机

**FR-22:** 系统必须在同步失败时显示详细的错误消息通知。

**FR-23:** 系统必须记录所有同步操作的日志，包括成功和失败的记录。

**FR-24:** 系统必须允许用户查看和清除日志记录。

**FR-25:** 系统必须在Cookie不存在时提示用户登录对应网站。

### 4.6 安全性

**FR-26:** 系统必须加密存储敏感信息（Client Secret）。

**FR-27:** 系统必须提供配置导出功能，导出时不包含敏感信息（Client Secret）。

**FR-28:** 系统必须提供配置导入功能，导入后提示用户补充敏感信息。

**FR-29:** 系统必须在配置导出/导入时提供明确的安全提示。

### 4.7 其他功能

**FR-30:** 系统必须记录每个网站配置的最后同步时间。

**FR-31:** 系统必须提供全局启用/禁用自动同步的开关。

**FR-32:** 系统必须在网络请求失败时进行重试（最多3次）。

### 4.8 青龙面板环境变量管理

**FR-33:** 系统必须能够从青龙面板获取所有环境变量列表。

**FR-34:** 系统必须以表格形式展示环境变量列表，包含以下信息：
- 环境变量名称
- 环境变量值（支持显示/隐藏敏感值）
- 状态（启用/禁用）
- 备注
- 创建时间
- 更新时间

**FR-35:** 系统必须提供环境变量搜索功能，支持按名称或备注搜索。

**FR-36:** 系统必须提供环境变量过滤功能，支持按状态（启用/禁用）过滤。

**FR-37:** 系统必须支持对环境变量进行排序（按名称、创建时间、更新时间）。

**FR-38:** 系统必须允许用户添加新的环境变量，包括：
- 环境变量名称（必填）
- 环境变量值（必填）
- 备注（可选）

**FR-39:** 系统必须允许用户编辑现有环境变量的值和备注。

**FR-40:** 系统必须允许用户删除环境变量，删除前需要二次确认。

**FR-41:** 系统必须支持批量删除环境变量（多选）。

**FR-42:** 系统必须允许用户启用或禁用环境变量。

**FR-43:** 系统必须支持批量启用或禁用环境变量。

**FR-44:** 系统必须提供环境变量刷新功能，从青龙面板重新获取最新数据。

**FR-45:** 系统必须在环境变量列表中标识哪些环境变量与插件的网站配置关联。

**FR-46:** 系统必须支持复制环境变量值到剪贴板功能。

**FR-47:** 系统必须在执行环境变量操作前验证青龙面板连接是否有效。

**FR-48:** 系统必须在环境变量操作（增删改）成功后显示成功提示。

**FR-49:** 系统必须在环境变量操作失败时显示详细错误信息。

**FR-50:** 系统必须支持分页显示环境变量（每页显示50条，可配置）。

## 5. 非目标（范围外）

**NG-01:** 本版本不支持除青龙面板外的其他平台（如v2board、其他自动化平台）。

**NG-02:** 本版本不提供Cookie的加密传输功能（假设用户使用HTTPS连接青龙面板）。

**NG-03:** 本版本不支持多账号管理（一个网站同时管理多个账号的Cookie）。

**NG-04:** 本版本不提供统计分析功能（如同步成功率统计、趋势分析等）。

**NG-05:** 本版本不支持Cookie的格式转换或处理（直接传输原始Cookie值）。

**NG-06:** 本版本不提供青龙面板的定时任务、脚本、依赖等其他管理功能（仅提供环境变量的完整管理）。

## 6. 设计考虑

### 6.1 UI/UX设计

- **设计风格：** 简洁现代，使用Material Design或类似设计系统
- **配色方案：** 
  - 主色：蓝色（#1976D2）
  - 成功：绿色（#4CAF50）
  - 错误：红色（#F44336）
  - 警告：橙色（#FF9800）
- **Popup尺寸：** 宽度400px，高度600px（可滚动）
- **Options页面：** 响应式布局，支持不同屏幕尺寸

### 6.2 环境变量管理界面设计

环境变量管理页面应包含以下元素：

**顶部工具栏：**
- 搜索框（支持实时搜索）
- 过滤下拉框（全部/已启用/已禁用）
- 排序下拉框（按名称/创建时间/更新时间）
- 刷新按钮
- 添加环境变量按钮

**表格主体：**
- 多选框列（用于批量操作）
- 名称列（可点击排序）
- 值列（默认隐藏，带显示/隐藏切换按钮，带复制按钮）
- 状态列（启用/禁用标签，带关联标识）
- 备注列（可为空）
- 更新时间列（相对时间显示）
- 操作列（编辑/删除按钮）

**底部操作栏：**
- 批量启用按钮
- 批量禁用按钮
- 批量删除按钮
- 分页控制器

**弹窗：**
- 添加/编辑环境变量对话框
- 删除确认对话框

### 6.3 配置向导流程

```
[欢迎页面] 
   ↓
[青龙面板配置] → [测试连接]
   ↓
[添加网站配置]
   ↓
[完成页面] → [执行首次同步]
```

### 6.4 数据结构设计

**网站配置对象：**
```javascript
{
  id: string,           // 唯一标识符
  name: string,         // 网站名称
  url: string,          // 目标URL
  envName: string,      // 青龙环境变量名
  enabled: boolean,     // 是否启用
  autoSync: boolean,    // 是否自动同步
  lastSync: timestamp,  // 最后同步时间
  lastStatus: string    // 最后同步状态
}
```

**青龙面板配置：**
```javascript
{
  qlUrl: string,
  clientId: string,
  clientSecret: string  // 需加密存储
}
```

**同步日志：**
```javascript
{
  id: string,
  timestamp: number,
  siteId: string,
  siteName: string,
  status: 'success' | 'failed',
  message: string
}
```

**青龙环境变量对象（从API获取）：**
```javascript
{
  id: number,           // 青龙面板中的ID
  name: string,         // 环境变量名称
  value: string,        // 环境变量值
  remarks: string,      // 备注
  status: number,       // 0=禁用, 1=启用
  createdAt: timestamp, // 创建时间
  updatedAt: timestamp, // 更新时间
  isLinked: boolean     // 是否关联到插件的网站配置（客户端计算）
}
```

## 7. 技术考虑

### 7.1 Chrome APIs

- **chrome.cookies:** 获取Cookie
- **chrome.storage.local:** 存储配置（加密敏感信息）
- **chrome.alarms:** 定时同步
- **chrome.notifications:** 通知用户
- **chrome.runtime:** 消息传递
- **chrome.action:** 更新徽章状态

### 7.2 青龙面板API集成

需要使用的青龙面板API端点：

- **获取Token:** `GET /open/auth/token?client_id={id}&client_secret={secret}`
- **获取环境变量列表:** `GET /open/envs` (需要Bearer Token)
- **创建环境变量:** `POST /open/envs` (需要Bearer Token)
- **更新环境变量:** `PUT /open/envs` (需要Bearer Token)
- **删除环境变量:** `DELETE /open/envs` (需要Bearer Token)
- **启用环境变量:** `PUT /open/envs/enable` (需要Bearer Token)
- **禁用环境变量:** `PUT /open/envs/disable` (需要Bearer Token)

### 7.3 安全性实现

- 使用Web Crypto API对Client Secret进行加密存储
- 导出配置时生成JSON文件，明确标注不包含敏感信息
- 所有与青龙面板的通信使用HTTPS
- Token在内存中缓存，过期后自动重新获取

### 7.4 性能考虑

- Cookie变化监听使用防抖（debounce），避免频繁同步
- 日志记录限制最大条目数（如最多保留1000条）
- 使用异步操作，避免阻塞UI
- 环境变量列表缓存5分钟，减少API调用

### 7.5 兼容性

- 目标Chrome版本：Manifest V3
- 最低Chrome版本：88+

## 8. 成功指标

**SM-01:** 用户能够在5分钟内完成首次配置并成功同步一个网站的Cookie。

**SM-02:** Cookie同步成功率达到95%以上（排除网络问题和用户配置错误）。

**SM-03:** 用户能够通过配置向导独立完成所有设置，无需查阅文档。

**SM-04:** 自动同步功能能够在Cookie变化后5分钟内完成同步。

**SM-05:** 错误信息能够让用户明确知道问题所在和解决方法。

**SM-06:** 用户能够在插件中快速查找并编辑特定的环境变量，无需打开青龙面板网页。

## 9. 开放问题

**OQ-01:** Cookie变化检测的灵敏度如何平衡？太频繁可能影响性能，太慢可能导致Cookie过期。
- **建议：** 默认使用5分钟的防抖延迟，允许用户在高级设置中调整。

**OQ-02:** 日志保留策略？保留多少条记录？保留多长时间？
- **建议：** 默认保留最近1000条记录或30天内的记录，以先达到者为准。

**OQ-03:** 是否需要支持Cookie的过滤（只同步特定Cookie）？
- **建议：** 第一版本获取所有Cookie，后续版本根据用户反馈考虑添加过滤功能。

**OQ-04:** 批量同步时是否并行执行？还是串行执行？
- **建议：** 串行执行，避免青龙面板API限流，每个同步间隔1秒。

**OQ-05:** 配置导入时如何处理ID冲突？
- **建议：** 导入时为所有配置生成新的ID，避免与现有配置冲突。

**OQ-06:** 是否需要支持代理设置（访问青龙面板时）？
- **建议：** 第一版本不支持，使用浏览器默认代理设置。

**OQ-07:** 环境变量列表是否需要缓存？缓存策略如何设计？
- **建议：** 缓存环境变量列表在本地（5分钟有效期），提供手动刷新按钮。在执行增删改操作后自动刷新缓存。

**OQ-08:** 环境变量值显示时，是否默认隐藏敏感信息？
- **建议：** 默认显示为星号（****），提供眼睛图标按钮切换显示/隐藏，提高安全性。

---

## 附录：现有代码分析

当前`background.js`已实现的功能：
- ✅ 基础配置管理
- ✅ 定时同步（chrome.alarms）
- ✅ 获取特定Cookie（pt_key, pt_pin）
- ✅ 青龙面板API集成（获取token、更新环境变量）
- ✅ 基础错误处理
- ✅ 徽章状态更新

需要增强或新增的功能：
- 🔨 支持多网站配置
- 🔨 获取所有Cookie（而非特定Cookie）
- ➕ Cookie变化监听
- ➕ 完整的UI界面（Popup和Options页面）
- ➕ 配置向导
- ➕ 同步历史和日志
- ➕ 连接测试功能
- ➕ 配置导入/导出
- ➕ 敏感信息加密
- ➕ 批量环境变量管理
- ➕ 青龙面板环境变量管理（获取、增删改查、搜索、过滤、排序）
- 🔨 增强的错误处理和通知

图例：
- ✅ 已实现
- 🔨 需要修改/增强
- ➕ 需要新增

